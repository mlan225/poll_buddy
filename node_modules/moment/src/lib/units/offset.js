import zeroFill from '../utils/zero-fill';
import { createDuration } from '../duration/create';
import { addSubtract } from '../moment/add-subtract';
import { isMoment, copyConfig } from '../moment/constructor';
import { addFormatToken } from '../format/format';
import { addRegexToken, matchOffset, matchShortOffset } from '../parse/regex';
import { addParseToken } from '../parse/token';
import { createLocal } from '../create/local';
import { prepareConfig } from '../create/from-anything';
import { createUTC } from '../create/utc';
import isDate from '../utils/is-date';
import toInt from '../utils/to-int';
import isUndefined from '../utils/is-undefined';
import compareArrays from '../utils/compare-arrays';
import { hooks } from '../utils/hooks';

// FORMATTING

<<<<<<< HEAD
function offset(token, separator) {
    addFormatToken(token, 0, 0, function () {
        var offset = this.utcOffset(),
            sign = '+';
=======
function offset (token, separator) {
    addFormatToken(token, 0, 0, function () {
        var offset = this.utcOffset();
        var sign = '+';
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
        if (offset < 0) {
            offset = -offset;
            sign = '-';
        }
<<<<<<< HEAD
        return (
            sign +
            zeroFill(~~(offset / 60), 2) +
            separator +
            zeroFill(~~offset % 60, 2)
        );
=======
        return sign + zeroFill(~~(offset / 60), 2) + separator + zeroFill(~~(offset) % 60, 2);
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    });
}

offset('Z', ':');
offset('ZZ', '');

// PARSING

<<<<<<< HEAD
addRegexToken('Z', matchShortOffset);
=======
addRegexToken('Z',  matchShortOffset);
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
addRegexToken('ZZ', matchShortOffset);
addParseToken(['Z', 'ZZ'], function (input, array, config) {
    config._useUTC = true;
    config._tzm = offsetFromString(matchShortOffset, input);
});

// HELPERS

// timezone chunker
// '+10:00' > ['10',  '00']
// '-1530'  > ['-15', '30']
var chunkOffset = /([\+\-]|\d\d)/gi;

function offsetFromString(matcher, string) {
<<<<<<< HEAD
    var matches = (string || '').match(matcher),
        chunk,
        parts,
        minutes;
=======
    var matches = (string || '').match(matcher);
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9

    if (matches === null) {
        return null;
    }

<<<<<<< HEAD
    chunk = matches[matches.length - 1] || [];
    parts = (chunk + '').match(chunkOffset) || ['-', 0, 0];
    minutes = +(parts[1] * 60) + toInt(parts[2]);

    return minutes === 0 ? 0 : parts[0] === '+' ? minutes : -minutes;
=======
    var chunk   = matches[matches.length - 1] || [];
    var parts   = (chunk + '').match(chunkOffset) || ['-', 0, 0];
    var minutes = +(parts[1] * 60) + toInt(parts[2]);

    return minutes === 0 ?
      0 :
      parts[0] === '+' ? minutes : -minutes;
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
}

// Return a moment from input, that is local/utc/zone equivalent to model.
export function cloneWithOffset(input, model) {
    var res, diff;
    if (model._isUTC) {
        res = model.clone();
<<<<<<< HEAD
        diff =
            (isMoment(input) || isDate(input)
                ? input.valueOf()
                : createLocal(input).valueOf()) - res.valueOf();
=======
        diff = (isMoment(input) || isDate(input) ? input.valueOf() : createLocal(input).valueOf()) - res.valueOf();
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
        // Use low-level api, because this fn is low-level api.
        res._d.setTime(res._d.valueOf() + diff);
        hooks.updateOffset(res, false);
        return res;
    } else {
        return createLocal(input).local();
    }
}

<<<<<<< HEAD
function getDateOffset(m) {
    // On Firefox.24 Date#getTimezoneOffset returns a floating point.
    // https://github.com/moment/moment/pull/1871
    return -Math.round(m._d.getTimezoneOffset());
=======
function getDateOffset (m) {
    // On Firefox.24 Date#getTimezoneOffset returns a floating point.
    // https://github.com/moment/moment/pull/1871
    return -Math.round(m._d.getTimezoneOffset() / 15) * 15;
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
}

// HOOKS

// This function will be called whenever a moment is mutated.
// It is intended to keep the offset in sync with the timezone.
hooks.updateOffset = function () {};

// MOMENTS

// keepLocalTime = true means only change the timezone, without
// affecting the local hour. So 5:31:26 +0300 --[utcOffset(2, true)]-->
// 5:31:26 +0200 It is possible that 5:31:26 doesn't exist with offset
// +0200, so we adjust the time as needed, to be valid.
//
// Keeping the time actually adds/subtracts (one hour)
// from the actual represented time. That is why we call updateOffset
// a second time. In case it wants us to change the offset again
// _changeInProgress == true case, then we have to adjust, because
// there is no such time in the given timezone.
<<<<<<< HEAD
export function getSetOffset(input, keepLocalTime, keepMinutes) {
=======
export function getSetOffset (input, keepLocalTime, keepMinutes) {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    var offset = this._offset || 0,
        localAdjust;
    if (!this.isValid()) {
        return input != null ? this : NaN;
    }
    if (input != null) {
        if (typeof input === 'string') {
            input = offsetFromString(matchShortOffset, input);
            if (input === null) {
                return this;
            }
        } else if (Math.abs(input) < 16 && !keepMinutes) {
            input = input * 60;
        }
        if (!this._isUTC && keepLocalTime) {
            localAdjust = getDateOffset(this);
        }
        this._offset = input;
        this._isUTC = true;
        if (localAdjust != null) {
            this.add(localAdjust, 'm');
        }
        if (offset !== input) {
            if (!keepLocalTime || this._changeInProgress) {
<<<<<<< HEAD
                addSubtract(
                    this,
                    createDuration(input - offset, 'm'),
                    1,
                    false
                );
=======
                addSubtract(this, createDuration(input - offset, 'm'), 1, false);
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
            } else if (!this._changeInProgress) {
                this._changeInProgress = true;
                hooks.updateOffset(this, true);
                this._changeInProgress = null;
            }
        }
        return this;
    } else {
        return this._isUTC ? offset : getDateOffset(this);
    }
}

<<<<<<< HEAD
export function getSetZone(input, keepLocalTime) {
=======
export function getSetZone (input, keepLocalTime) {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    if (input != null) {
        if (typeof input !== 'string') {
            input = -input;
        }

        this.utcOffset(input, keepLocalTime);

        return this;
    } else {
        return -this.utcOffset();
    }
}

<<<<<<< HEAD
export function setOffsetToUTC(keepLocalTime) {
    return this.utcOffset(0, keepLocalTime);
}

export function setOffsetToLocal(keepLocalTime) {
=======
export function setOffsetToUTC (keepLocalTime) {
    return this.utcOffset(0, keepLocalTime);
}

export function setOffsetToLocal (keepLocalTime) {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    if (this._isUTC) {
        this.utcOffset(0, keepLocalTime);
        this._isUTC = false;

        if (keepLocalTime) {
            this.subtract(getDateOffset(this), 'm');
        }
    }
    return this;
}

<<<<<<< HEAD
export function setOffsetToParsedOffset() {
=======
export function setOffsetToParsedOffset () {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    if (this._tzm != null) {
        this.utcOffset(this._tzm, false, true);
    } else if (typeof this._i === 'string') {
        var tZone = offsetFromString(matchOffset, this._i);
        if (tZone != null) {
            this.utcOffset(tZone);
<<<<<<< HEAD
        } else {
=======
        }
        else {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
            this.utcOffset(0, true);
        }
    }
    return this;
}

<<<<<<< HEAD
export function hasAlignedHourOffset(input) {
=======
export function hasAlignedHourOffset (input) {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    if (!this.isValid()) {
        return false;
    }
    input = input ? createLocal(input).utcOffset() : 0;

    return (this.utcOffset() - input) % 60 === 0;
}

<<<<<<< HEAD
export function isDaylightSavingTime() {
=======
export function isDaylightSavingTime () {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    return (
        this.utcOffset() > this.clone().month(0).utcOffset() ||
        this.utcOffset() > this.clone().month(5).utcOffset()
    );
}

<<<<<<< HEAD
export function isDaylightSavingTimeShifted() {
=======
export function isDaylightSavingTimeShifted () {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    if (!isUndefined(this._isDSTShifted)) {
        return this._isDSTShifted;
    }

<<<<<<< HEAD
    var c = {},
        other;
=======
    var c = {};
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9

    copyConfig(c, this);
    c = prepareConfig(c);

    if (c._a) {
<<<<<<< HEAD
        other = c._isUTC ? createUTC(c._a) : createLocal(c._a);
        this._isDSTShifted =
            this.isValid() && compareArrays(c._a, other.toArray()) > 0;
=======
        var other = c._isUTC ? createUTC(c._a) : createLocal(c._a);
        this._isDSTShifted = this.isValid() &&
            compareArrays(c._a, other.toArray()) > 0;
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    } else {
        this._isDSTShifted = false;
    }

    return this._isDSTShifted;
}

<<<<<<< HEAD
export function isLocal() {
    return this.isValid() ? !this._isUTC : false;
}

export function isUtcOffset() {
    return this.isValid() ? this._isUTC : false;
}

export function isUtc() {
=======
export function isLocal () {
    return this.isValid() ? !this._isUTC : false;
}

export function isUtcOffset () {
    return this.isValid() ? this._isUTC : false;
}

export function isUtc () {
>>>>>>> 7667619318f2e7e4ad64e58abdc3812448859fd9
    return this.isValid() ? this._isUTC && this._offset === 0 : false;
}
